services:
  pluie:
    image: ewenquim/pluie:latest
    build: .
    platform: linux/amd64
    container_name: pluie-app
    restart: unless-stopped
    depends_on:
      - weaviate-embeddings
    ports:
      - "9999:9999" # Left is host port (you can customize), right is container port (do not change)
    volumes:
      - ./vault:/vault # Left is host (you can set you own vault path), right is container (do not change)
      - ./data:/data # Left is host (you can set you own vault path), right is container (do not change)
    # Uncomment to disable file watching:
    # command: ./main -path /vault -watch=false
    environment:
      HOME_NOTE_SLUG: ACCUEIL # Default is "Index"
      SITE_TITLE: Pluie # Default "Pluie"
      SITE_DESCRIPTION: My personal knowledge base # Default empty
      SITE_ICON: https://avatars.githubusercontent.com/u/46993939?v=4 # Default empty (no icon)
      PUBLIC_BY_DEFAULT: true # Default false for privacy
      HIDE_YAML_FRONTMATTER: false # Default false
      CHAT_PROVIDER: ${PLUIE_CHAT_PROVIDER:-ollama} # ollama, openai, mistral
      CHAT_MODEL: ${PLUIE_CHAT_MODEL}
      OPENAI_API_KEY: ${PLUIE_OPENAI_API_KEY}
      MISTRAL_API_KEY: ${PLUIE_MISTRAL_API_KEY}
      EMBEDDINGS_TRACKING_FILE: /data/embeddings_tracking.json
    develop:
      watch:
        - action: rebuild
          path: .
          ignore:
            - tmp/
            - .git/
            - README.md
            - .gitignore
            - .dockerignore
        - action: sync
          path: ./vault
          target: /vault

  weaviate-embeddings:
    container_name: weaviate-embeddings
    command:
      - --host
      - 0.0.0.0
      - --port
      - "9035"
      - --scheme
      - http
    image: cr.weaviate.io/semitechnologies/weaviate:1.25.2
    ports:
      - 9035:9035
      - 50051:50051
    restart: on-failure:0
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: "true"
      PERSISTENCE_DATA_PATH: "/var/lib/weaviate"
      CLUSTER_HOSTNAME: "node1"

  ollama-models:
    image: ollama/ollama:latest
    container_name: ollama-models
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      # Persist models and configs across restarts
      - ollama_data:/root/.ollama
    # Uncomment if you want GPU passthrough (requires NVIDIA container toolkit)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

volumes:
  ollama_data:
